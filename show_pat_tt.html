<!DOCTYPE html>
<html>
<head>
    <title>Faculty Filtered Timetable</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; }

        table {
            width: 90%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }

        th {
            background: lightblue;
        }

        .batch-title {
            font-size: 20px;
            font-weight: bold;
            margin-top: 30px;
        }

        .highlight {
            background-color: red;
            color: white;
            font-weight: bold;
        }
    </style>
</head>

<body>

<h2>Upload CSV</h2>
<input type="file" id="csvFile" accept=".csv">

<br><br>

<label><b>Select Faculty:</b></label>
<select id="facultySelect">
    <option value="ALL">ALL</option>
</select>

<div id="tables"></div>

<script>
let timetable = {};

// Load CSV
document.getElementById("csvFile").addEventListener("change", function () {
    Papa.parse(this.files[0], {
        header: true,
        skipEmptyLines: true,
        complete: res => prepareData(res.data)
    });
});

// Prepare timetable
function prepareData(data) {
    timetable = {};
    const facultySet = new Set();

    data.forEach(row => {
        const batch = row.BATCH;
        const day = row.DAY;
        const session = row.SESSION;
        const course = row.COURSE;
        const room = row.ROOM;
        const faculty = row.FACULTY?.trim();

        if (!batch || !day || !session || !faculty) return;

        facultySet.add(faculty);

        if (!timetable[batch]) timetable[batch] = {};
        if (!timetable[batch][day]) timetable[batch][day] = { FN: null, AN: null };

        timetable[batch][day][session] = {
            text: `${course}<br>Room: ${room}<br>${faculty}`,
            faculty: faculty
        };
    });

    populateFacultyDropdown(facultySet);
    renderTables("ALL");
}

// Faculty dropdown
function populateFacultyDropdown(facultySet) {
    const select = document.getElementById("facultySelect");
    select.innerHTML = `<option value="ALL">ALL</option>`;

    [...facultySet].sort().forEach(fac => {
        const opt = document.createElement("option");
        opt.value = fac;
        opt.textContent = fac;
        select.appendChild(opt);
    });
}

// Faculty selection change
document.getElementById("facultySelect").addEventListener("change", function () {
    renderTables(this.value);
});

// Render tables
function renderTables(selectedFaculty) {
    const container = document.getElementById("tables");
    container.innerHTML = "";

    const days = ["MON", "TUE", "WED", "THU", "FRI", "SAT"];

    for (const batch in timetable) {

        // ðŸ”¹ Check if faculty exists in this batch
        let facultyPresent = false;

        if (selectedFaculty !== "ALL") {
            days.forEach(day => {
                ["FN", "AN"].forEach(session => {
                    const cell = timetable[batch][day]?.[session];
                    if (cell && cell.faculty === selectedFaculty) {
                        facultyPresent = true;
                    }
                });
            });

            if (!facultyPresent) continue; // ðŸš« Skip this batch
        }

        const title = document.createElement("div");
        title.className = "batch-title";
        title.textContent = `Batch: ${batch}`;
        container.appendChild(title);

        const table = document.createElement("table");

        let html = `
            <tr>
                <th>DAY</th>
                <th>FN</th>
                <th rowspan="7">L<br>U<br>N<br>C<br>H</th>
                <th>AN</th>
            </tr>
        `;

        days.forEach(day => {
            html += `<tr><td>${day}</td>`;

            ["FN", "AN"].forEach(session => {
                const cell = timetable[batch][day]?.[session];

                if (!cell) {
                    html += `<td></td>`;
                } else {
                    const highlight =
                        selectedFaculty !== "ALL" &&
                        cell.faculty === selectedFaculty;

                    html += `
                        <td class="${highlight ? 'highlight' : ''}">
                            ${cell.text}
                        </td>
                    `;
                }
            });

            html += `</tr>`;
        });

        table.innerHTML = html;
        container.appendChild(table);
    }
}
</script>

</body>
</html>
